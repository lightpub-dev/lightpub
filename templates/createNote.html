<div class="card create-note layout-left-sidebar">
  {{if .ReplyToID}}
  <h3>{{.Title}}</h3>
  {{else}}
  <h2>{{.Title}}</h2>
  {{end}}
  <form
    hx-post="/note"
    method="POST"
    enctype="multipart/form-data"
    hx-swap="none"
    hx-on::after-request="if(event.detail.successful) {
      this.reset();
      $data.mentions = [];
      $data.tags = [];
      $data.content = '';
    }"
  >
    {{if .ReplyToID}}
    <input type="hidden" name="replyToId" value="{{.ReplyToID}}" />
    {{end}}
    <div class="form-group" x-data="{ content: '' }">
      <label for="content">投稿内容</label>
      <textarea
        id="content"
        name="content"
        class="form-control"
        placeholder="あいうえお"
        required="required"
        aria-required="true"
        x-model="content"
        {{if
        not
        .Authed}}
        disabled
        title="投稿するにはログインしてください"
        {{end}}
      ></textarea>
    </div>

    <details>
      <summary>メンション</summary>
      <div class="form-group" x-data="{ mentions: [], currentMention: '' }">
        <div class="input-group mb-2">
          <input
            type="text"
            class="form-control"
            placeholder="@username or @username@domain.tld"
            x-model="currentMention"
            x-on:keydown.enter.prevent="if(currentMention.match(/^@[\w]+(@[\w.]+)?$/) && !mentions.includes(currentMention)) { mentions.push(currentMention); currentMention = ''; }"
          />
          <button
            class="btn btn-primary"
            type="button"
            x-on:click="if(currentMention.match(/^@[\w]+(@[\w.]+)?$/) && !mentions.includes(currentMention)) { mentions.push(currentMention); currentMention = ''; }"
          >
            Add
          </button>
        </div>
        <div class="mention-list">
          <template x-for="(mention, index) in mentions" :key="index">
            <div
              class="alert alert-secondary d-flex justify-content-between align-items-center"
            >
              <span x-text="mention"></span>
              <button
                type="button"
                class="btn-close"
                x-on:click="mentions.splice(index, 1)"
              ></button>
              <input type="hidden" name="mentions[]" x-bind:value="mention" />
            </div>
          </template>
        </div>
      </div>
    </details>

    <details>
      <summary>タグ</summary>
      <div class="form-group" x-data="{ tags: [], currentTag: '' }">
        <div class="input-group mb-2">
          <input
            type="text"
            class="form-control"
            placeholder="#tag"
            x-model="currentTag"
            x-on:keydown.enter.prevent="if(currentTag.trim() !== '') { 
              let tagValue = currentTag.startsWith('#') ? currentTag : '#' + currentTag;
              if(!tags.includes(tagValue)) { 
                tags.push(tagValue); 
                currentTag = ''; 
              }
            }"
          />
          <button
            class="btn btn-primary"
            type="button"
            x-on:click="if(currentTag.trim() !== '') { 
              let tagValue = currentTag.startsWith('#') ? currentTag : '#' + currentTag;
              if(!tags.includes(tagValue) && !tagValue.substring(1).includes('#')) { 
                tags.push(tagValue); 
                currentTag = ''; 
              }
            }"
          >
            Add
          </button>
        </div>
        <div class="tag-list">
          <template x-for="(tag, index) in tags" :key="index">
            <div
              class="alert alert-secondary d-flex justify-content-between align-items-center"
            >
              <span x-text="tag"></span>
              <button
                type="button"
                class="btn-close"
                x-on:click="tags.splice(index, 1)"
              ></button>
              <input type="hidden" name="tags[]" x-bind:value="tag" />
            </div>
          </template>
        </div>
      </div>
    </details>

    <div class="form-group">
      <label for="visibilityForm">公開範囲</label>
      <select
        name="visibility"
        class="form-select"
        id="visibilityForm"
        required
      >
        <option value="public">Public</option>
        <option value="unlisted">Unlisted</option>
        <option value="follower">Follower</option>
        <option value="private">Private</option>
      </select>
    </div>
    <div class="form-group">
      <label for="contentTypeForm">コンテンツタイプ</label>
      <select
        id="contentTypeForm"
        name="contentType"
        class="form-select"
        required
        aria-required="true"
      >
        <option value="plain" selected>テキスト</option>
        <option value="md">Markdown</option>
        <option value="latex">LaTeX</option>
      </select>
    </div>
    <div class="form-group">
      <label for="uploads">ファイルアップロード</label>
      <input
        type="file"
        id="uploads"
        name="file"
        class="form-control"
        accept="image/*"
        multiple
      />
    </div>
    <div class="form-group">
      <label for="sensitive">センシティブ</label>
      <input type="checkbox" id="sensitive" name="sensitive" />
    </div>
    {{if .Authed}}
    <button type="submit" class="btn btn-primary">投稿</button>
    {{else}}
    <button
      type="submit"
      class="btn btn-primary"
      disabled
      title="投稿するにはログインしてください"
    >
      投稿
    </button>
    {{end}}
  </form>
</div>
